---
layout: post
title:  "OpenGL 3D场景坐标到2D屏幕坐标的过程研究"
image: ''
date:   2021-03-31 11:16:03
tags:
- OpenGL
description: ''
categories: 
- OpenGL
---

![图片](..\assets\img\opengl\perspective_frustum.png)



**已知 FOV(俯仰角) W/H 宽高比  近平面  远平面**
1. FOV的角度和近平面的距离可以算出近平面的高度H
2. 根据宽高比 可以确定近平面的宽度
3. 之后再根据摄像机的朝向和摄像机在世界坐标系中的位置，可以唯一确定近平面/远平面组成的半锥体的位置,**这个半锥体被称为'透视平截头体'**  

**以摄像机为原点，摄像机朝向方向为Z轴负方向，相机的左边为X轴方向，相机的上边为Y轴正方向组成的坐标系被称为'视觉坐标系' 或者 '观察坐标系'**

假设平截头体内部有一点P(x0,y0,z0),同时近平面的Z轴坐标是已知的-n,  
那么可以通过相似三角型求出在近平面上的投影坐标Q
Q = ( (n*x0) / (-z0) , (n*y0) / (-z0) )

已知近平面的宽度W,可知近平面最左边的坐标为-W/2,右边为W/2  
假设L表示最左边的坐标，R表示最右边的坐标,  
那么只需要将[L,R] 映射到[-1,1]的范围内,那么就可以将投影坐标Q的X坐标映射到[-1,1]当中，  
同理对Z轴做同样的操作可以将投影坐标Q的Y坐标映射到[-1,1]当中  

我们将平截头体在视觉空间的坐标在近平面的投影坐标 约束到(-1,1)的范围内 即:转换成标准设备坐标系(NDC)

最后标准设备坐标系[-1,-1] 映射到屏幕坐标空间当中  这个过程被称为'视口变换'




* 假设有一个设计分辨率为 1136 * 640 的平面UI,放在位置(100,100,100),那么如何设置相机参数使得平面正好被摄像机完全投影到？
1. 因为是UI平面,所以需要在最上层显示,所以UI平面的位置需要跟近平面重合,即近平面的距离Z为100
2. 需要设置宽高比为1136 / 640,此时我们有近平面高度H、近平面的距离,可以逆推出FOV
3. 根据平面UI所组成的平面,求出与平面正交的向量,然后乘以近平面的距离,我们可以得出相机所在位置以及相机的朝向(垂直指向平面的中点)  
4. 最后我们得出了相机所需要的所有参数(远平面根据需要设置,只要比近平面远就行)


**PS:因为UI是不会随着摄像机移动而移动的,所以UI需要一个单独的摄像机处理,并且这个相机是不可以移动的**