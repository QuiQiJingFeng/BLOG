---
layout: post
title:  "切后台操作的一些问题和优化方法"
image: ''
date:   2024-09-09 18:00:22
tags:
- Cocos
description: ''
categories: 
- Cocos
---
### 1、场景转换过程中切后台  
最完美的方案是在applicationDidEnterBackground中阻塞直到完成这一轮mainLoop。  
这就要求每帧的mainLoop时间必须控制在一定范围内,否则用户体验会比较差。

所以要控制渲染的时间片段,将渲染任务分成小片段，确保每个渲染任务都可以在短时间内完成。

1. 同步的网络请求应该尽可能的减少,因为在网络差的情况下,可能导致该帧消耗更多的时间。
2. 避免在单个渲染帧中进行大量的计算,如果有这种要求的话最好可以分帧计算。
3. 对于需要创建大量UI的场景,提前将合图进行分帧加载或者UI分帧创建,避免场景创建消耗大量时间


但是这种方案不太可控,原因是:
1. 不同的设备性能不一样
2. 随着应用的复杂性提升想要控制单个mainLoop的时间在一定范围就更加困难。  
3. 一些三方SDK消耗的时间以及一些场景涉及到多个模块等等。  

另一种方案是swapBuffers的时候判断一下当前是否在后台,如果在后台就跳过swapBuffers

```c++
// swap buffers
    if (_openGLView && _invalid)
    {
        _openGLView->swapBuffers();
    }
```

### 2、异步回调时恰好在后台
1. 异步返回的时候要判断一下当前是否处于后台,处于后台的话就加入后台消息队列,等返回前台时再执行