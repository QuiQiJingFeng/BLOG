---
layout: post
title:  "托管与非托管的区别"
image: ''
date:   2021-05-28 15:26:20
tags:
- C#
description: ''
categories: 
- C#
---
而C#的机制与Java类似，运行于.net平台上的代码，分配的资源一般会自动由平台的垃圾回收器释放，这样的资源就是托管资源。  
但是一些例外的资源，如System.IO.StreamReader等各种流、各种连接所分配的资源，需要显式调用Close()或Dispose()释放，这种资源就叫做非托管资源。  

C#中编写非托管代码,在非托管代码中，即可进行指针相关的操作
```c#
unsafe
{
//非托管代码
}

```


* 托管代码  

.NET Framework的核心是其运行库的执行环境，称为公共语言运行库(CLR)或.NET运行库。通常将在CLR的控制下运行的代码称为托管代码(managed code)。  

运行库环境（而不是直接由操作系统）执行的代码。托管代码应用程序可以获得公共语言运行库服务，例如自动垃圾回收、运行库类型检查和安全支持等。这些服务帮助提供独立于平台和语言的、统一的托管代码应用程序行为。

　　托管代码是可以使用20多种支持Microsoft .NET Framework的高级语言编写的代码，它们包括：C#, J#, Microsoft Visual Basic .NET, Microsoft JScript .NET, 以及C++。所有的语言共享统一的类库集合，并能被编码成为中间语言(IL)。运行库编译器（runtime-aware ompiler）在托管执行环境下编译中间语言（IL）使之成为本地可执行的代码，并使用数组边界和索引检查，异常处理，垃圾回收等手段确保类型的安全。

　　在托管执行环境中使用托管代码及其编译，可以避免许多典型的导致安全黑洞和不稳定程序的编程错误。同样，许多不可靠的设计也自动的被增强了安全性，例如类型安全检查，内存管理和释放无效对象。程序员可以花更多的精力关注程序的应用逻辑设计并可以减少代码的编写量。这就意味着更短的开发时间和更健壮的程序。

简单点说，托管代码是microsoft的中间语言，他主要的作用是在.NET FRAMEWORK的CLR执行代码前去编译源代码，也就是说托管代码充当着翻译的作用，源代码在运行时分为两个阶段：

1.源代码编译为托管代码；（所以源代码可以有很多种，如VB,C#,J#)

2.托管代码编译为microsoft系统的.net平台专用文件(如类库、可执行文件等)。

* 非托管代码 (unmanaged code)

在公共语言运行库环境的外部，由操作系统直接执行的代码。非托管代码必须提供自己的垃圾回收、类型检查、安全支持等服务；它与托管代码不同，后者从公共语言运行库中获得这些服务。



## 不安全代码和指针类型
你编写的大多数 C# 代码都是“可验证的安全代码”。 可验证的安全代码表示 .NET 工具可以验证代码是否安全。 通常，安全代码不会直接使用指针访问内存， 也不会分配原始内存， 而是创建托管对象。

C# 支持 unsafe 上下文，你可在其中编写不可验证的代码。 在 unsafe 上下文中，代码可使用指针、分配和释放内存块，以及使用函数指针调用方法。 C# 中的不安全代码不一定是危险的，它只是其安全性不可验证的代码。

不安全代码具有以下属性：
* 可将方法、类型和代码块定义为不安全。
* 在某些情况下，通过移除数组绑定检查，不安全代码可提高应用程序的性能。
* 调用需要指针的本机函数时，需使用不安全代码。
* 使用不安全代码将引发安全风险和稳定性风险。
* 必须使用 AllowUnsafeBlocks 编译器选项来编译包含不安全块的代码。