---
layout: post
title:  "Unity3D 合批处理"
image: ''
date:   2022-08-11 15:20:21
tags:
- Unity
description: ''
categories: 
- Unity
---
[参考文档1](https://zhuanlan.zhihu.com/p/352463394)
[参考文档2](https://blog.csdn.net/weixin_42186870/article/details/117675164)

# 离线合批
离线合批就是在游戏运行前，先用工具把相关资源做合批处理，以减轻引擎实时合批的负担。  

# 实时合批
## 静态合批 

### unity中的使用  
1. PlayerSettings中开启static batching，  
2. 对需要静态合批物体的Static打钩即可

### 静态合批的原理
静态合批最关重要的一件事就是合并网格。  
游戏引擎会把渲染器中的网格信息取出来，之后对网格上的顶点进行空间变换，变换到同一坐标系下，合并成一个新的大网格。  

```一个模型可能由非常多的物体组成的,每个物体的顶点和索引数据都是在该物体自己的本地坐标下定义的。坐标系不同的话,那么模型矩阵就不同,进而无法使用同一个shader,所以也就无法合并批次来处理。```  

```静态合批做的就是这个工作,将模型的顶点在游戏启动之前提前转换到同一个坐标系下,并将数据写入文件当中,这样在游戏运行的过程当中就可以直接使用提前转换到同一个坐标系下的顶点数据,就可以使用同一个shader。```

```静态合批采用了以空间换时间的策略来提升渲染效率,所以会相应的增加包体。```

### 动态合批的原理 

动态合批是专门为优化场景中共享同一材质的动态GameObject的渲染设计的。目标是以最小的代价合并小型网格模型，减少Drawcall。  
动态合批的原理也很简单，在进行场景绘制之前将所有的共享同一材质的模型的顶点信息变换到世界空间中(所以适合这种的应该是不动的物体)，然后通过一次Draw call绘制多个模型，达到合批的目的。模型顶点变换的操作是由CPU完成的，所以这会带来一些CPU的性能消耗。
动态合批会对合批的模型大小有些要求,太大的话会导致消耗过多CPU，具体可以看上面的**参考文档1**

```动态合批其实就是把静态合批的操作放到游戏运行时动态执行,所以会消耗更多的Cpu性能```

静态合批和动态合批都有各自的缺点,所以用的时候要考虑具体的情况再使用。


### GPU Instancing
[参考文档3](https://learnopengl-cn.github.io/04%20Advanced%20OpenGL/10%20Instancing/)

将数据一次性发送给GPU，然后使用一个绘制函数让OpenGL利用这些数据绘制多个物体。
适用于需要将一个模型绘制非常多次,仅仅有些旋转或者缩放以及位置上的差异,比如草地上有上万根草，
但是位置、大小、缩放有些差异。

[参考文档4](https://zhuanlan.zhihu.com/p/34499251)  


# 2D游戏
对于2D游戏来说,并不需要合并网格来处理合批.
1. 可以通过离线合图的方式(**SpriteAtlas**)提前将一些渲染顺序中相邻的碎图合并到一张合图上,从而完成合并批次
2. 可以运行中动态将一些碎图打到合图中,例如背包就适合这种,因为道具种类多,但是背包里组合并不固定,  
所以动态合图就可以省下非常多CPU消耗。
3. GPU Instancing 也可以使用